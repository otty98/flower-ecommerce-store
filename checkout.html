<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Checkout - Bloom & Blossom</title>
  <!-- Yoco SDK -->
  <script src="https://js.yoco.com/sdk/v1/yoco-sdk-web.js"></script>
  <!-- PayPal SDK -->
  <script src="https://www.paypal.com/sdk/js?client-id=AfmKqda6-0dlfyT29ey0BzcOge7y490LFQlEfGov7Iq7t4JuFxprqDd4dfNSASrcjlh1XRSnUKOkFvYC&currency=USD"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f8f8f8;
      padding: 2rem;
    }
    .checkout-container {
      max-width: 600px;
      margin: auto;
      background: #fff;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      text-align: center;
    }
    h1 {
      margin-bottom: 1rem;
      color: #333;
    }
    .payment-options {
      margin-top: 2rem;
    }
    .checkout-btn {
      background: #4ecdc4;
      color: #fff;
      padding: 0.8rem 1.2rem;
      border: none;
      border-radius: 5px;
      font-size: 1rem;
      margin: 1rem;
      cursor: pointer;
    }
    .yoco-sdk-popup {
        z-index: 9999 !important;
    }
    .loading {
      display: none;
      margin: 1rem 0;
      color: #666;
    }

    .spinner {
  animation: rotate 2s linear infinite;
  height: 20px;
  width: 20px;
  margin-right: 10px;
  vertical-align: middle;
}

.spinner circle {
  stroke: #4ecdc4;
  stroke-linecap: round;
  animation: dash 1.5s ease-in-out infinite;
}

@keyframes rotate {
  100% { transform: rotate(360deg); }
}

@keyframes dash {
  0% {
    stroke-dasharray: 1, 150;
    stroke-dashoffset: 0;
  }
  50% {
    stroke-dasharray: 90, 150;
    stroke-dashoffset: -35;
  }
  100% {
    stroke-dasharray: 90, 150;
    stroke-dashoffset: -124;
  }
}
  </style>
</head>
<body>
    <div class="checkout-container">
  <h1>Secure Checkout</h1>
  <p>Total Amount: <strong id="cartTotal">R0.00</strong></p>
  
  <div class="payment-options">
    <button id="yoco-btn" class="checkout-btn">Pay with Card (Yoco)</button>
    <div id="paypal-button-container"></div>
  </div>
  
  <div id="loading" class="loading">
    <svg class="spinner" viewBox="0 0 50 50">
      <circle cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle>
    </svg>
    Processing your payment...
  </div>
</div>

    <div class="test-instructions" style="
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
        padding: 1rem;
        margin-bottom: 1.5rem;
        border-radius: 5px;
        font-size: 0.95rem;
    ">
        ⚠️ <strong>Test Mode Active</strong><br>
        This is a demo store. Use the test details below to simulate a payment:<br><br>
        <strong>Yoco Test Card:</strong><br>
        Card Number: <code>4242 4242 4242 4242</code><br>
        Expiry: <code>12/30</code> | CVV: <code>123</code> | Name: <code>Any Name</code><br><br>
        <strong>PayPal Sandbox Buyer:</strong><br>
        Email: <code>sb-xamds44360061@personal.example.com</code><br>
        Password: <code>nX%0dW>n</code><br>
        Card: Use fake card saved in PayPal account.<br><br>
        <em>For OTP, enter 6 zeros</em>
    </div>

  <script>
  // Enhanced Checkout Script
  document.addEventListener('DOMContentLoaded', async () => {
    // Get cart data
    const cartItems = JSON.parse(localStorage.getItem('cart')) || [];
    const totalAmount = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    document.getElementById('cartTotal').textContent = `R${totalAmount.toFixed(2)}`;
    
    // Initialize payment buttons
    initPayPalButton();
    initYocoSDK(totalAmount);
  });

  // UI Helpers
  function showLoading() {
    document.getElementById('loading').style.display = 'block';
    document.querySelectorAll('.checkout-btn').forEach(btn => {
      btn.disabled = true;
    });
  }

  function hideLoading() {
    document.getElementById('loading').style.display = 'none';
    document.querySelectorAll('.checkout-btn').forEach(btn => {
      btn.disabled = false;
    });
  }

  function showError(message) {
    alert(`Error: ${message}`);
    window.location.href = 'cancel.html';
  }

  // Order Processing
  async function createOrder(paymentMethod, paymentId) {
    const cartItems = JSON.parse(localStorage.getItem('cart')) || [];
    const totalAmount = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    
    try {
      const response = await fetch('/api/orders', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          paymentMethod,
          paymentId,
          amount: totalAmount,
          items: cartItems,
          status: 'completed'
        })
      });

      if (!response.ok) {
        throw new Error('Failed to create order');
      }

      return await response.json();
    } catch (error) {
      console.error('Order creation failed:', error);
      throw error;
    }
  }

  // Yoco Integration
  function initYocoSDK(totalAmount) {
    const yoco = new window.YocoSDK({
      publicKey: 'pk_test_YOCO_PUBLIC_KEY' // Replace with your test key
    });

    document.getElementById('yoco-btn').addEventListener('click', async () => {
      showLoading();
      
      try {
        yoco.showPopup({
          amountInCents: Math.round(totalAmount * 100),
          currency: 'ZAR',
          name: 'Bloom & Blossom',
          description: `Order Payment (${cartItems.length} items)`,
          callback: async function(result) {
            if (result.error) {
              throw new Error(result.error.message);
            }

            try {
              const order = await createOrder('yoco', result.id);
              localStorage.removeItem('cart');
              window.location.href = `success.html?orderId=${order.id}`;
            } catch (orderError) {
              console.error('Order processing failed:', orderError);
              showError('Payment succeeded but order creation failed');
            }
          }
        });
      } catch (error) {
        showError(error.message);
      } finally {
        hideLoading();
      }
    });
  }

  // PayPal Integration
  function initPayPalButton() {
    paypal.Buttons({
      style: {
        shape: 'rect',
        color: 'gold',
        layout: 'vertical',
        label: 'paypal'
      },

      createOrder: function(data, actions) {
        return actions.order.create({
          purchase_units: [{
            amount: {
              value: (totalAmount / 18).toFixed(2), // Convert ZAR to USD
              currency_code: 'USD'
            },
            description: `Flower Order (${cartItems.length} items)`
          }]
        });
      },

      onApprove: async function(data, actions) {
        showLoading();
        try {
          const details = await actions.order.capture();
          const order = await createOrder('paypal', data.orderID);
          
          localStorage.removeItem('cart');
          window.location.href = `success.html?orderId=${order.id}`;
        } catch (error) {
          showError('Payment processing failed');
        } finally {
          hideLoading();
        }
      },

      onError: function(err) {
        showError('Payment failed: ' + err.message);
      },

      onCancel: function(data) {
        window.location.href = 'cancel.html';
      }
    }).render('#paypal-button-container');
  }
</script>
</html>